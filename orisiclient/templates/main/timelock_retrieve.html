{% extends "base.html" %}
{% load widget_tweaks %}

{% block content %}
<style type="text/css">
  @media (min-width: 768px) {
    .container {
      width:100%;
      max-width: 730px;
    }
  }
</style>
<div class="row">
  <div class="col-xs-12">
    <div class="jumbotron">
      <div id="before" class="center">
        <h2>Creating timelock...</h2>
        <p>Waiting for Oracles to respond</p>
        <div class="results">
          <div id="circleG">
            <div id="circleG_1" class="circleG">
            </div>
            <div id="circleG_2" class="circleG">
            </div>
            <div id="circleG_3" class="circleG">
            </div>
          </div>
        </div>
      </div>
      <div id="afterSuccess" style="display:none;" class="center text-center">
        <h1>Timelock Created!</h1>
        <hr>
        <p>Please send your timelock money to <B><span class="address" class="strong"></span></B>.</p>
        <p>You need to send amount ending with <span class="tx_mark strong"></span>. For example:
        <b>0.00500<span class="tx_mark"></span></b>. That way we can recognize this transaction from many others you may schedule.
        Use calculator below to get the amount you need to send.
        </p>
        <hr>
        <h2>How much would you like to send?</h2>
        <div class="row">

            <div class="form-group" style="margin-top:5px;"> 
              <input id="firstInput" class="form-control" min=0 placeholder="Amount in BTC" type="number" step="0.00000001"/>
            </div>

        </div>

          <div class="row">
            <div class="text-center">
              <p style="font-size: 60px; color: gray;">
              <span class="glyphicon glyphicon-arrow-down"></span>
              </p>
            </div></div>

          <div class="row">
            <div class="form-group" style="margin-top:5px;">
              <input style="background-color: navajowhite; color: forestgreen" id="secondInput" class="form-control" min=0 placeholder="How much should you send" type="number" readonly="True"/>
            </div>
          </div>


      <div class="text-center">
        <p>Oracles will wait for your transaction for no more than <b>30 minutes</b>. This means we will delete this contract when there is no initial transaction.</p>
      </div>
      </div>
      <div id="afterFailure" style="display:none;" class="center">
        <h2>Please use different address</h2>
        <p>You have used this address for previous contract, please use another return address.</p>
        <a href="{% url 'main:timelock' %}" class="btn btn-lg btn-primary">Create New</a>
      </div>
      <div id="liveMonitoring" style="display:none;">
        <hr>
        <h2>Monitoring <span class="address"></span> for mark <span class="tx_mark"></span></h2>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Txid</th>
              <th>Confirmations</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody id="liveTable">
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">

function updateView(results) {
  htmlLines = [];
  for (txid in results) {
    transaction = results[txid];
    shortTx = txid.substring(0, 30) + "...";
    line = [
      '<tr>',
      '<td><a href="http://btc.blockr.io/tx/info/' + txid + '">' + shortTx + '</a></td>',
      '<td>' + transaction['confirmations'] + '</td>',
      '<td>' + transaction['amount'] + '</td>',
      '</tr>'
        ].join('\n');
    htmlLines.push(line);
  }
  $('#liveTable').html(htmlLines.join('\n'));
}

function monitorResults(btc, address) {
  results = btc.getResults();
  address_results = results[address];

  var new_results = {}
  for (k in address_results) {
    r = address_results[k];
    final_vout = undefined;
    for (var j = 0; j < r['trade']['vouts'].length; ++j) {
      vout = r['trade']['vouts'][j];
      if (vout['address'] == address) {
        final_vout = vout;
      }
    }
    r['amount'] = final_vout['amount'];
    new_results[k] = r;
  }

  updateView(new_results);
}

function startObserving(address, mark) {
  var btc = btcMonitor();
  var actualDate = new Date();
  var oldDate = new Date(actualDate.getTime() - 6000000);
  btc.addObservedByMark(address, mark, oldDate);

  btc.run();

  setInterval(monitorResults.bind(undefined, btc, address), 1000);
}

function checkResults(results) {
  if (results['result'] == 'success') {
    clearInterval(tt);

    if (results['created'] == 'yes'){
      r = results['results'][0];

      address = r['addr'];
      mark = r['mark'];
      mark = mark.toString();
      time = r['time'];

      prefix = "";
      diff = 4 - mark.length;
      for (var i = 0; i < diff; i ++) {
        prefix += "0";
      }

      mark = prefix + mark;

      $('.address').each(function(){
          $(this).html(address);
      });
      $('.tx_mark').each(function(){
          $(this).html(mark);
      });
      $('#time').html(time);

      $('#firstInput').on('input', function(){
        value = $(this).val();
        if (value) {
          sendAmount = parseFloat(value).toFixed(4);
          $('#secondInput').val(sendAmount + mark);
        }
      });

      $('#before').remove();
      $('#afterSuccess').css('display', 'block');
      $('#liveMonitoring').css('display', 'block');

      startObserving(address, mark);
    } else {
      $('#before').remove();
      $('#afterFailure').css('display', 'block');
    }
  }
}

function getResults() { 
  $.ajax({
    url: '/get_timelock_for_address?message_id={{ta.message_id}}',
    type: "get",
  }).done(function(data){
    checkResults(data);
  });
}

tt = setInterval(getResults, 1000);

</script>

{% endblock %}
