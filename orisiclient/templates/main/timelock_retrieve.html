{% extends "base.html" %}
{% load widget_tweaks %}

{% block content %}

     <script type="text/javascript">
            var cog = new Image();
            function init() {
                cog.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABsAAAAbCAYAAACN1PRVAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABK1JREFUeNqMVt1ZGzkUvVfS4IW1l8GO82w6IBXE7mCpAFMB+Pt4Z6iApALcAe4AU0HoAJfg7BPYHinnXmmciX+y0YdmJHnQ0bk/R5cvh5cUyFPwRD4EChgEvGWMB36R3+JaiTkmD5gOs8yNb25uLlerFf1pM2yIGA82TEY7xow1oj4GBU6S6yywPNG4JwDH+XGv0Whs7ndN8n97mmPsLCSYgy7ImPQE/pFDyAF+7L0fgTNFUDBcLal90taD1doQ/T6NT9DnW8zkT+jJuQVYukG3hifCVk/L3JOxMBa8VVlSp9MhHKLaB+zpNo1fdgEpmByuMqUAV5viOQLwXNax9KBAFNEEpN1pUwnQmvl6aTza6zNjrCKaymeyOdYAMgfg18iG4T/qw+AC94zvpzDjcwqOXo3VGH26H0xMZ7jPxgT0R2zUi4BYt6bAfEbJvJFZKA4ODgZ5nhcJLE9mk35X21vWC/TXKmiwr2xszoQd/PQv3t/QCzY2twpqBpb5FKOp+hCgzWaTWq0W1Xx0ij5An9WC5VtiLMwvNBrVaSGMvQk5jHQVPN7sb0HzAtE+QJrNgrcUNEARieWCut0ugR0tl8sKcJ5Ahc3jRviPK8ZGTaaBwGKyT+gTiwM4a3Jrba6MbeVXo5F4kp9shn29ndUYC9vLirGDXzRhrYhD8DME5Hkg22df5rDYS/RXmVIsaP/Q/SXs600YnifTjbeSWliEdTYb3QyTqYfdDKTL4B1KS6tVqf6SgGq3P9BvZGpvNIrPCgVKZlGlCDQDxJiCjVppCab05DJHzb+b1Gm36X80cVjLuzozexs0f6IgRkA5XRhzIixRL1+IzhwdHVHrn1Y9oXe1i10aKT6bGGhg1CKK+cT0zCGCs0oXTIogybJMw/779//o48duMvnO9rzLn+Kz8wgS5Shqo4njpCoOQA5Ajb8adHh4SMvVghaLhYb/HsBip88krNVISSEigOlhjmi0LziNhr6wOsgO9C1339vbGznnNAU2AM9Svk235cqKieKGkldAf7DGvTrjnjJnzyQoMu0ZTuZgUqvmlYR+f39XIE4uqCX1E/rDZpCYmKwOOmivAfYK9KF1AM7EdG4uAMLAOjmQideQXOJQkyUisqYiFRhtSFbxCxj8do0T30dmTvLhC+an0MZZVBHX09tBTG4qFigZEJEChjTIEwtRik81Qa7uOQU0IrYAe7FRjqYw6SlYjgAyN1GmHsFIGPfVnxzFuFITKEkfYK+oWZ5qKlIkcZ7UE92oXBmeIgIxtAO5UtSHqo9uiLW+sme5ejSIRASeAFR4LYy8MMzL1aq3EYWzJF28BgMEzGYpBkrMKelgl+P6uTcVY8NjLYyYPwMTCcufSaouH6al9xNJcjC82vDb9uVZKbrWIumNO+waVsu1TCC+Wxcg6xaSpsZSYM2wLO9/U8qZWH+wztQnsfAxV/E3MIKZVf1FsmJVV8mamhEmxZ0X7sSsABsGv1tZJGejmptU7FBUDYzPAXQBwFEEl+9+stFEroJEci2ELwIMmZuWoSTE9DYYcWVCjlJrZWMpeBhlAEqBiulPE84S3ixU5gSTwGGOdyEVNJXxA8nPevshwABHktBS1YoQ+QAAAABJRU5ErkJggg=='; // Set source path
                setInterval(draw,10);
            }
            var rotation = 0;
            function draw(){
                var ctx = document.getElementById('myCanvas').getContext('2d');
                ctx.globalCompositeOperation = 'destination-over';
                ctx.save();
                ctx.clearRect(0,0,27,27);
                ctx.translate(13.5,13.5); // to get it in the origin
                rotation +=1;
                ctx.rotate(rotation*Math.PI/64); //rotate in origin
                ctx.translate(-13.5,-13.5); //put it back
                ctx.drawImage(cog,0,0);
                ctx.restore();
            }
            init();
        </script>

    <style type="text/css">
  @media (min-width: 768px) {
    .container {
      width:100%;
      max-width: 730px;
    }
  }
</style>
<div class="row">
  <div class="col-xs-12">
    <div class="jumbotron">
      <div id="before" class="center">
        <h2>Creating timelock...</h2>
        <p>Waiting for Oracles to respond</p>
        <div class="results">
          <div id="circleG">
            <div id="circleG_1" class="circleG">
            </div>
            <div id="circleG_2" class="circleG">
            </div>
            <div id="circleG_3" class="circleG">
            </div>
          </div>
        </div>
      </div>
      <div id="afterSuccess" style="display:none;" class="center text-center">
        <h1>Timelock Created!</h1>
        <hr>
        <p>Please send your timelock money to <B><span class="address" class="strong"></span></B>.</p>
        <p>You need to send amount ending with <span class="tx_mark strong"></span>. For example:
        <b>0.00500<span class="tx_mark"></span></b>. That way we can recognize this transaction from many others you may schedule.
        Use calculator below to get the amount you need to send.
        </p>
        <hr>
        <h2>How much would you like to send?</h2>
        <div class="row">

            <div class="form-group" style="margin-top:5px;"> 
              <input id="firstInput" class="form-control" min=0 placeholder="Amount in BTC" type="number" step="0.00000001"/>
            </div>

        </div>

          <div class="row">
            <div class="text-center">
              <p style="font-size: 60px; color: gray;">
              <span class="glyphicon glyphicon-arrow-down"></span>
              </p>
            </div></div>

          <div class="row">
            <div class="form-group" style="margin-top:5px;">
              <input style="background-color: navajowhite; color: forestgreen" id="secondInput" class="form-control" min=0 placeholder="How much should you send" type="number" readonly="True"/>
            </div>
          </div>


      <div class="text-center">
        <p>Oracles will wait for your transaction for no more than <b>30 minutes</b>. This means we will delete this contract when there is no initial transaction.</p>
      </div>
      </div>
      <div id="afterFailure" style="display:none;" class="center">
        <h2>Please use different address</h2>
        <p>You have used this address for previous contract, please use another return address.</p>
        <a href="{% url 'main:timelock' %}" class="btn btn-lg btn-primary">Create New</a>
      </div>
      <div class="text-center" id="liveMonitoring" style="display:none;">

              If you haven't done it already, now it's time to go to your wallet and send your "timelock" money. After we receive a confirmation you will see your transaction coming in below.

              <h2> Monitoring Blockchain for your transaction </h2>
<canvas width="27" height="27" id="myCanvas"></canvas>
             <div>address: <span class="address"></span></div>

          <table class="table table-striped">
          <thead>
            <tr>
              <th>Txid</th>
              <th>Confirmations</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody id="liveTable">
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">

function updateView(results) {
  htmlLines = [];
  for (txid in results) {
    transaction = results[txid];
    shortTx = txid.substring(0, 30) + "...";
    line = [
      '<tr>',
      '<td><a href="http://btc.blockr.io/tx/info/' + txid + '">' + shortTx + '</a></td>',
      '<td>' + transaction['confirmations'] + '</td>',
      '<td>' + transaction['amount'] + '</td>',
      '</tr>'
        ].join('\n');
    htmlLines.push(line);
  }
  $('#liveTable').html(htmlLines.join('\n'));
}

function monitorResults(btc, address) {
  results = btc.getResults();
  address_results = results[address];

  var new_results = {}
  for (k in address_results) {
    r = address_results[k];
    final_vout = undefined;
    for (var j = 0; j < r['trade']['vouts'].length; ++j) {
      vout = r['trade']['vouts'][j];
      if (vout['address'] == address) {
        final_vout = vout;
      }
    }
    r['amount'] = final_vout['amount'];
    new_results[k] = r;
  }

  updateView(new_results);
}

function startObserving(address, mark) {
  var btc = btcMonitor();
  var actualDate = new Date();
  var oldDate = new Date(actualDate.getTime() - 6000000);
  btc.addObservedByMark(address, mark, oldDate);

  btc.run();

  setInterval(monitorResults.bind(undefined, btc, address), 1000);
}

function checkResults(results) {
  if (results['result'] == 'success') {
    clearInterval(tt);

    if (results['created'] == 'yes'){
      r = results['results'][0];

      address = r['addr'];
      mark = r['mark'];
      mark = mark.toString();
      time = r['time'];

      prefix = "";
      diff = 4 - mark.length;
      for (var i = 0; i < diff; i ++) {
        prefix += "0";
      }

      mark = prefix + mark;

      $('.address').each(function(){
          $(this).html(address);
      });
      $('.tx_mark').each(function(){
          $(this).html(mark);
      });
      $('#time').html(time);

      $('#firstInput').on('input', function(){
        value = $(this).val();
        if (value) {
          sendAmount = parseFloat(value).toFixed(4);
          $('#secondInput').val(sendAmount + mark);
        }
      });

      $('#before').remove();
      $('#afterSuccess').css('display', 'block');
      $('#liveMonitoring').css('display', 'block');

      startObserving(address, mark);
    } else {
      $('#before').remove();
      $('#afterFailure').css('display', 'block');
    }
  }
}

function getResults() { 
  $.ajax({
    url: '/get_timelock_for_address?message_id={{ta.message_id}}',
    type: "get",
  }).done(function(data){
    checkResults(data);
  });
}

tt = setInterval(getResults, 1000);

</script>

{% endblock %}
